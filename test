param (
    [string]$InputFile = "C:\SqlParser\input.sql",
    [string]$TableDefPath = "C:\SqlParser\table_definitions",
    [string]$OutputFile = "C:\SqlParser\output.txt"
)

# -----------------------------
# Load SQL file
# -----------------------------
$sqlText = Get-Content $InputFile -Raw

# Normalize whitespace
$sqlText = $sqlText -replace "\r\n", "`n"

# -----------------------------
# Load Table Definitions
# -----------------------------
$tableColumns = @{}

Get-ChildItem $TableDefPath -Filter *.sql | ForEach-Object {
    $tableSql = Get-Content $_.FullName -Raw
    if ($tableSql -match "(?i)create\s+table\s+([\w\.\[\]]+)\s*\(([\s\S]+?)\)") {
        $tableName = $matches[1].Trim("[]")
        $colsBlock = $matches[2]

        $cols = @()
        foreach ($line in $colsBlock -split ",") {
            if ($line -match "^\s*([\[\]\w]+)\s+") {
                $cols += $matches[1].Trim("[]")
            }
        }
        $tableColumns[$tableName.ToLower()] = $cols
    }
}

# -----------------------------
# Split Stored Procedures
# -----------------------------
$procedures = [regex]::Split(
    $sqlText,
    "(?i)(?=create\s+procedure|alter\s+procedure)"
)

$output = @()

foreach ($proc in $procedures) {

    if ($proc -notmatch "(?i)(create|alter)\s+procedure\s+([\w\.\[\]]+)") { continue }

    $procName = $matches[2].Trim("[]")
    $output += "======================================="
    $output += "Stored Procedure: $procName"
    $output += "---------------------------------------"

    # -----------------------------
    # Extract Tables + Aliases
    # -----------------------------
    $tables = @{}
    $tableRegex = "(?i)(from|join)\s+([\w\.\[\]]+)(?:\s+(?:as\s+)?(\w+))?"

    foreach ($m in [regex]::Matches($proc, $tableRegex)) {
        $table = $m.Groups[2].Value.Trim("[]")
        $alias = $m.Groups[3].Value

        if (-not $tables.ContainsKey($table)) {
            $tables[$table] = @()
        }
        if ($alias) {
            $tables[$table] += $alias
        }
    }

    # -----------------------------
    # Extract Column References
    # -----------------------------
    $columnRegex = "(?i)(\b\w+\b)\.(\b\w+\b)"
    $columns = @()

    foreach ($m in [regex]::Matches($proc, $columnRegex)) {
        $columns += @{
            Prefix = $m.Groups[1].Value
            Column = $m.Groups[2].Value
        }
    }

    # -----------------------------
    # Resolve Columns to Tables
    # -----------------------------
    $resolved = @{}

    foreach ($col in $columns) {
        foreach ($table in $tables.Keys) {
            $aliases = $tables[$table]
            if ($aliases -contains $col.Prefix -or
                $table.Split(".")[-1] -eq $col.Prefix) {

                if (-not $resolved.ContainsKey($table)) {
                    $resolved[$table] = @()
                }
                $resolved[$table] += $col.Column
            }
        }
    }

    # -----------------------------
    # Infer Unqualified Columns
    # -----------------------------
    $unqualifiedRegex = "(?i)\bselect\b([\s\S]+?)\bfrom\b"
    if ($proc -match $unqualifiedRegex) {
        $selectBlock = $matches[1]

        foreach ($token in ($selectBlock -split ",")) {
            if ($token -match "^\s*(\w+)\s*$") {
                $colName = $matches[1].ToLower()
                foreach ($table in $tables.Keys) {
                    if ($tableColumns.ContainsKey($table.ToLower()) -and
                        $tableColumns[$table.ToLower()] -contains $colName) {

                        if (-not $resolved.ContainsKey($table)) {
                            $resolved[$table] = @()
                        }
                        $resolved[$table] += $colName
                    }
                }
            }
        }
    }

    # -----------------------------
    # Output Formatting
    # -----------------------------
    foreach ($table in $resolved.Keys) {
        $output += "Table: $table"
        $output += "  Columns:"
        $resolved[$table] | Sort-Object -Unique | ForEach-Object {
            $output += "    - $_"
        }
    }

    $output += ""
}

# -----------------------------
# Write Output
# -----------------------------
$output | Set-Content $OutputFile -Encoding UTF8
