param (
    [string]$InputFile  = "C:\SqlParser\input.sql",
    [string]$OutputFile = "C:\SqlParser\output.txt"
)

# -----------------------------
# Read SQL File
# -----------------------------
$sqlText = Get-Content $InputFile -Raw
$sqlText = $sqlText -replace "\r\n", "`n"

# -----------------------------
# Split Stored Procedures
# -----------------------------
$procedures = [regex]::Split(
    $sqlText,
    "(?i)(?=create\s+procedure|alter\s+procedure)"
)

$output = @()

foreach ($proc in $procedures) {

    if ($proc -notmatch "(?i)(create|alter)\s+procedure\s+([\w\.\[\]]+)") {
        continue
    }

    $procName = $matches[2].Trim("[]")

    $output += "======================================="
    $output += "Stored Procedure: $procName"
    $output += "---------------------------------------"

    # -----------------------------
    # Extract Tables and Aliases
    # -----------------------------
    $tables = @{}
    $tableRegex = "(?i)(from|join)\s+([\w\.\[\]]+)(?:\s+(?:as\s+)?(\w+))?"

    foreach ($m in [regex]::Matches($proc, $tableRegex)) {
        $tableName = $m.Groups[2].Value.Trim("[]")
        $alias     = $m.Groups[3].Value

        if (-not $tables.ContainsKey($tableName)) {
            $tables[$tableName] = @()
        }

        if ($alias -and -not $tables[$tableName].Contains($alias)) {
            $tables[$tableName] += $alias
        }
    }

    # -----------------------------
    # Extract Column References (qualified)
    # -----------------------------
    $columns = @{}
    $columnRegex = "(?i)\b(\w+)\.(\w+)\b"

    foreach ($m in [regex]::Matches($proc, $columnRegex)) {
        $prefix = $m.Groups[1].Value
        $column = $m.Groups[2].Value

        foreach ($table in $tables.Keys) {
            $tableShort = $table.Split('.')[-1]
            $aliases    = $tables[$table]

            if ($prefix -ieq $tableShort -or $aliases -contains $prefix) {
                if (-not $columns.ContainsKey($table)) {
                    $columns[$table] = @()
                }
                if (-not $columns[$table].Contains($column)) {
                    $columns[$table] += $column
                }
            }
        }
    }

    # -----------------------------
    # Detect Unqualified Columns
    # -----------------------------
    $unresolvedColumns = @()
    $selectRegex = "(?i)\bselect\b([\s\S]+?)\bfrom\b"

    if ($proc -match $selectRegex) {
        $selectBlock = $matches[1]

        foreach ($item in ($selectBlock -split ",")) {
            $item = $item.Trim()
            if ($item -notmatch "\.") {
                if ($item -match "\b(\w+)\b") {
                    $unresolvedColumns += $matches[1]
                }
            }
        }
    }

    # -----------------------------
    # Output Tables
    # -----------------------------
    if ($tables.Count -gt 0) {
        $output += "Tables:"
        foreach ($t in $tables.Keys) {
            $output += "  - $t"
        }
    }

    # -----------------------------
    # Output Columns
    # -----------------------------
    if ($columns.Count -gt 0) {
        $output += "Columns by Table:"
        foreach ($t in $columns.Keys) {
            $output += "  Table: $t"
            foreach ($c in $columns[$t] | Sort-Object) {
                $output += "    - $c"
            }
        }
    }

    # -----------------------------
    # Output Unresolved Columns
    # -----------------------------
    if ($unresolvedColumns.Count -gt 0) {
        $output += "Unresolved Columns (no table/alias reference):"
        foreach ($c in ($unresolvedColumns | Sort-Object -Unique)) {
            $output += "  - $c"
        }
    }

    $output += ""
}

# -----------------------------
# Write Output File
# -----------------------------
$output | Set-Content $OutputFile -Encoding UTF8

